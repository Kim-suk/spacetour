<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>3D ì§€êµ¬ë³¸ ë‚ ì”¨ ì •ë³´</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
    }
    #globeViz {
      width: 100vw;
      height: 100vh;
    }
    #weatherInfo {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
      z-index: 999;
    }
    #searchBox {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #0008;
      padding: 10px;
      border-radius: 8px;
      z-index: 1000;
    }
    #suggestList {
      position: absolute;
      top: 60px;
      right: 20px;
      background: #222;
      list-style: none;
      padding: 10px;
      margin: 0;
      border-radius: 8px;
      z-index: 1001;
      color: #fff;
    }
    #suggestList li {
      padding: 5px;
      cursor: pointer;
    }
    #suggestList li:hover {
      background: #333;
    }
  </style>
</head>
<body>

<div id="globeViz"></div>
<div id="weatherInfo">
  ğŸŒ í´ë¦­í•˜ê±°ë‚˜ ë„ì‹œëª…ì„ ê²€ìƒ‰í•´ ë‚ ì”¨ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”!
  <div id="exchangeInfo" style="margin-top: 10px;"></div>
</div>


<div id="searchBox">
  <input id="citySearch" type="text" placeholder="ë„ì‹œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" />
  <button onclick="searchCity()">ê²€ìƒ‰</button>
   <button onclick="clearMarkers()">Clear</button>
</div>
<ul id="suggestList"></ul>

<script src="https://unpkg.com/three@0.150.1/build/three.min.js"></script>
<script src="https://unpkg.com/globe.gl"></script>

<script>
 // ë§ˆì»¤ ì´ˆê¸°í™” í•¨ìˆ˜ ì¶”ê°€
function clearMarkers() {
  markerData.length = 0;
  globe.objectsData([]); // Globeì—ì„œ ë§ˆì»¤ ì œê±°
  document.getElementById("weatherInfo").innerHTML = "ğŸŒ í´ë¦­í•˜ê±°ë‚˜ ë„ì‹œëª…ì„ ê²€ìƒ‰í•´ ë‚ ì”¨ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”!";
}
  const globe = Globe()
    (document.getElementById('globeViz'))
    .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
    .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
    .showAtmosphere(true)
    .atmosphereColor('#3a228a')
    .atmosphereAltitude(0.25)
    .backgroundColor('#000')
    .onGlobeClick(async ({ lat, lng }) => {
  fetchWeather(lat, lng);

  const countryCode = await fetchCountryCode(lat, lng);
  addMarker(lat, lng, countryCode);
});


  // ìë™ ë° ìˆ˜ë™ íšŒì „ ì„¤ì •
  globe.controls().autoRotate = true;
  globe.controls().autoRotateSpeed = 0.5;
  globe.controls().enableRotate = true;   // ë§ˆìš°ìŠ¤ë¡œ íšŒì „ ê°€ëŠ¥
  globe.controls().enableZoom = true;     // í™•ëŒ€/ì¶•ì†Œ í—ˆìš©
  globe.controls().enablePan = false;     // í™”ë©´ ì´ë™ ì œí•œ
  
function fetchCountryCode(lat, lon) {
  const username = 'sukyung'; // GeoNames ì‚¬ìš©ì ID
  const url = `https://secure.geonames.org/countryCodeJSON?lat=${lat}&lng=${lon}&username=${username}`;

  return fetch(url)
    .then(res => res.json())
    .then(data => data.countryCode)
    .catch(err => {
      console.error("êµ­ê°€ ì½”ë“œ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", err);
      return 'KR'; // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’
    });
}

const markerData = [];

function createFlagSprite(countryCode) {
  const flagUrl = `https://flagcdn.com/w80/${countryCode.toLowerCase()}.png`;
  const textureLoader = new THREE.TextureLoader();
  const spriteMaterial = new THREE.SpriteMaterial({
    map: textureLoader.load(flagUrl),
    depthTest: false
  });
  const sprite = new THREE.Sprite(spriteMaterial);
  sprite.scale.set(11, 9, 8); // êµ­ê¸° í¬ê¸° ì¡°ì •
  return sprite;
}

function addMarker(lat, lon, countryCode) {
  // ì¤‘ë³µëœ ë‚˜ë¼ ì½”ë“œëŠ” ì´ë¯¸ ë“±ë¡ëœ ë§ˆì»¤ ë°ì´í„°ì— ìˆëŠ”ì§€ í™•ì¸
  const isExist = markerData.some(marker => marker.countryCode === countryCode);
  if (isExist) {
    // ê°™ì€ ë‚˜ë¼ êµ­ê¸°ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ë§ˆì»¤ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
    return;
  }

  const sprite = createFlagSprite(countryCode);

  markerData.push({
    lat: +lat,
    lng: +lon,
    obj: sprite,
    countryCode: countryCode // ì¤‘ë³µ ì²´í¬ìš©ìœ¼ë¡œ countryCode ì €ì¥
  });

  globe
    .objectsData(markerData)
    .objectLat('lat')
    .objectLng('lng')
    .objectAltitude(0.02)
    .objectThreeObject('obj');
}


function fetchWeather(lat, lon, cityLabel = null) {
  const apiKey = '3d9d58c3101549fd3a37eed43698b7ee';
  const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=kr`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (data.cod !== 200) {
        console.error('ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      const locationName = cityLabel || data.name;
      const countryName = data.sys.country;
      const weather = data.weather[0].description;
      const temp = data.main.temp;
      const humidity = data.main.humidity;
      const wind = data.wind.speed;
      const icon = data.weather[0].icon;

      document.getElementById("weatherInfo").innerHTML = `
        <h3>ğŸ“ ${locationName}, ${countryName}</h3>
        <img src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="ë‚ ì”¨ ì•„ì´ì½˜">
        <p>ğŸŒ¤ ë‚ ì”¨: ${weather}</p>
        <p>ğŸŒ¡ ì˜¨ë„: ${temp}â„ƒ</p>
        <p>ğŸ’§ ìŠµë„: ${humidity}%</p>
        <p>ğŸ’¨ í’ì†: ${wind} m/s</p>
      `;

      fetchExchangeRate(countryName);
    })
    .catch(err => console.error('ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err));
}


// ìˆ˜ì •ëœ searchCity í•¨ìˆ˜
function searchCity() {
  const city = document.getElementById("citySearch").value.trim();
  if (!city) {
    alert("ë„ì‹œëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  fetch(`https://secure.geonames.org/searchJSON?q=${encodeURIComponent(city)}&maxRows=1&username=sukyung`)
    .then(res => res.json())
    .then(async data => {
      if (data.totalResultsCount === 0) {
        alert("ë„ì‹œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const loc = data.geonames[0];
      const lat = loc.lat;
      const lon = loc.lng;
      const cityLabel = loc.name;

      // êµ­ê°€ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      const countryCode = await fetchCountryCode(lat, lon);

      globe.pointOfView({ lat: +lat, lng: +lon, altitude: 1.5 }, 2000);
      fetchWeather(lat, lon, cityLabel, countryCode);
      addMarker(lat, lon, countryCode);
    })
    .catch(err => {
      console.error("GeoNames API ì˜¤ë¥˜:", err);
      alert("ë„ì‹œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    });
}


 document.getElementById("citySearch").addEventListener("input", function () {
  const input = this.value.trim();
  if (input.length < 2) return;

  fetch(`https://secure.geonames.org/searchJSON?q=${encodeURIComponent(input)}&maxRows=5&username=sukyung`)
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById("suggestList");
      list.innerHTML = "";
      if (!data.geonames || data.geonames.length === 0) return;

      data.geonames.forEach(city => {
        const li = document.createElement("li");
        li.textContent = `${city.name}, ${city.countryName || city.countryCode}`;
        li.onclick = () => {
          document.getElementById("citySearch").value = `${city.name}, ${city.countryName || city.countryCode}`;
          list.innerHTML = "";
          globe.pointOfView({ lat: +city.lat, lng: +city.lng, altitude: 1.5 }, 2000);
          fetchWeather(city.lat, city.lng, city.name);
          addMarker(city.lat, city.lng, city.countryCode);
        };
        list.appendChild(li);
      });
    })
    .catch(err => {
      console.error("ìë™ì™„ì„± API ì˜¤ë¥˜:", err);
    });
});


  // í˜„ì¬ ìœ„ì¹˜ ê¸°ë°˜ ì´ˆê¸° ë‚ ì”¨
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      globe.pointOfView({ lat: latitude, lng: longitude, altitude: 1.5 }, 2000);
      fetchWeather(latitude, longitude);
    }, err => {
      console.warn("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", err.message);
    });
  } else {
    alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  }

</script>

</body>
</html>
